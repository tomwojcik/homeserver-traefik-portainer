services:
  forgejo:
    image: codeberg.org/forgejo/forgejo:14
    container_name: forgejo
    restart: always
    environment:
      - USER_UID=${PUID:-1000}
      - USER_GID=${PGID:-1000}
      - FORGEJO__database__DB_TYPE=sqlite3
      - FORGEJO__server__DOMAIN=git.${SERVER_DOMAIN}
      - FORGEJO__server__SSH_DOMAIN=git.${SERVER_DOMAIN}
      - FORGEJO__server__ROOT_URL=https://git.${SERVER_DOMAIN}/
    volumes:
      - /volume1/docker/forgejo-git-mirror/data:/data
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "2224:22"  # SSH for Git operations
    networks:
      - homeserver
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - my.zone=homeserver
      - traefik.enable=true
      - traefik.http.routers.forgejo.rule=Host(`git.${SERVER_DOMAIN}`)
      - traefik.http.routers.forgejo.entrypoints=websecure
      - traefik.http.routers.forgejo.tls.certresolver=myresolver
      - traefik.http.services.forgejo.loadbalancer.server.port=3000
      - traefik.docker.network=homeserver

  git-mirror-sync:
    image: ghcr.io/raylabshq/gitea-mirror:latest
    container_name: git-mirror-sync
    restart: always
    environment:
      - GITEA_URL=http://forgejo:3000
      - GITEA_TOKEN=${FORGEJO_TOKEN}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - PRIVATE_REPOSITORIES=true
      - MIRROR_STARRED=false
      - MIRROR_ORGANIZATIONS=true
      - PRESERVE_ORG_STRUCTURE=true
      - SCHEDULE_ENABLED=true
      - GITEA_MIRROR_INTERVAL=24h
    networks:
      - homeserver
    security_opt:
      - no-new-privileges:true
    depends_on:
      forgejo:
        condition: service_healthy
    labels:
      - my.zone=homeserver
      - traefik.enable=true
      - traefik.http.routers.git-mirror-sync.rule=Host(`git-mirror.${SERVER_DOMAIN}`)
      - traefik.http.routers.git-mirror-sync.entrypoints=websecure
      - traefik.http.routers.git-mirror-sync.tls.certresolver=myresolver
      - traefik.http.services.git-mirror-sync.loadbalancer.server.port=4321
      - traefik.docker.network=homeserver

networks:
  homeserver:
    name: homeserver
    external: true